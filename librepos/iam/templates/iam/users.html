{% extends 'base.html' %}

{% import "components/footer.j2" as Footer %}
{% import "components/dropdown.j2" as Dropdown %}
{% import "components/forms.j2" as Form %}
{% import "components/modal.j2" as Modal %}

{% block sidenav %}
    {% include "iam/_sidenav.html" %}
{% endblock %}

{% block breadcrumb %}
    {% include '_partials/breadcrumbs.html' %}
{% endblock %}

{% block main %}

    <section class="section">
        <div class="px-4">
            <div class="card-panel">
                {% if users %}
                    <table class="highlight striped">
                        <thead>
                        <tr>
                            <th>Image</th>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Last Active</th>
                            <th>Status</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for user in users %}
                            <tr>
                                <td class="center-align">
                                    <img src="{{ url_for('static', filename='images/'+user.profile.image) }}"
                                         alt="User avatar" class="circle avatar-nav">
                                </td>
                                <td>
                                    <a href="{{ url_for('iam.user', slug=user.slug) }}">
                                        {{ user.username|title }}
                                    </a>
                                </td>
                                <td>{{ user.role.name if user.role else "N/A" }}</td>
                                <td>{{ user.last_login_at|timeago }}</td>
                                <td>{{ user.status|title }}</td>
                            </tr>
                        {% endfor %}

                        </tbody>

                    </table>
                {% else %}
                    <h4 class="center-align">No users found.</h4>
                {% endif %}
            </div>
        </div>
    </section>

{% endblock %}


{% block footer %}
    {% call Footer.render() %}
        {{ Footer.item("Search", icon="search", modal="searchModal") }}
        {{ Footer.item("Add", icon="add_circle", url=url_for('iam.add_user')) }}
        {{ Footer.item("Filter", icon="filter_alt", dropdown="filter-dropdown") }}
        {{ Footer.item("Sort", icon="sort", dropdown="sort-dropdown") }}
        {{ Footer.item("Export", icon="download", dropdown="export-dropdown") }}
    {% endcall %}

    {# Search Modal #}
    <div id="searchModal" class="modal small" popover>
        <form action="{{ url_for('iam.users') }}" method="get">
            <div class="modal-header">
                <h5>Search Users</h5>
            </div>
            <div class="modal-content">
                <div class="input-field">
                    <i class="material-symbols-rounded prefix">search</i>
                    <input type="text" id="search-input" name="q"
                           value="{{ request.args.get('q', '') }}"
                           placeholder="Search by username or email..."
                           autofocus>
                    <label for="search-input" class="sr-only">Search users</label>
                </div>
            </div>
            <div class="modal-footer">
                <a href="{{ url_for('iam.users') }}" class="btn text waves-effect">
                    <i class="material-symbols-rounded">clear</i>
                    <span>&nbsp;Clear</span>
                </a>
                <button type="submit" class="btn filled waves-effect waves-light">
                    <i class="material-symbols-rounded">search</i>
                    <span>&nbsp;Search</span>
                </button>
            </div>
        </form>
    </div>

    {# Filter Dropdown #}
    {% call Dropdown.render("filter-dropdown") %}
        {{ Dropdown.item("All Users", icon="group", url="?status=") }}
        {{ Dropdown.divider() }}
        {{ Dropdown.item("Active", icon="check_circle", url="?status=active") }}
        {{ Dropdown.item("Pending", icon="hourglass_top", url="?status=pending") }}
        {{ Dropdown.item("Invited", icon="mail", url="?status=invited") }}
        {{ Dropdown.item("Suspended", icon="pause_circle", url="?status=suspended") }}
        {{ Dropdown.item("Deactivated", icon="cancel", url="?status=deactivated") }}
        {{ Dropdown.item("Locked", icon="lock", url="?status=locked") }}
    {% endcall %}

    {# Sort Dropdown #}
    {% call Dropdown.render("sort-dropdown") %}
        {{ Dropdown.item("Username", icon="person", url="?sort=username") }}
        {{ Dropdown.item("Role", icon="badge", url="?sort=role") }}
        {{ Dropdown.item("Last Active", icon="schedule", url="?sort=last_active") }}
        {{ Dropdown.item("Status", icon="toggle_on", url="?sort=status") }}
    {% endcall %}

    {# Export Dropdown #}
    {% call Dropdown.render("export-dropdown") %}
        {{ Dropdown.item("Export CSV", icon="download", url="?export=csv") }}
    {% endcall %}

    {# Add User Modal #}
    {% call Modal.form_modal("addUserModal", title="Add User", action=url_for("iam.add_user"), _class="small") %}
        {{ Form.render_form(form, extra_wrappers={'submit': 'hide'}) }}
    {% endcall %}
{% endblock %}