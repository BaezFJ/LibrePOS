{#
    Modal Macros
    ============
    Dialog components for confirmations, forms, and search.

    Import:
        {% import "macros/modals.html" as Modal %}

    Basic Modal:
        {{ Modal.trigger("help-modal", label="Help", icon="help") }}

        {% call Modal.render("help-modal", title="Help & Support") %}
            <p>Contact support at support@example.com</p>
        {% endcall %}

    Form Modal:
        {% call Modal.form_modal("create-category", title="New Category", action=url_for('menu.create_category')) %}
            {{ Forms.render(category_form) }}
        {% endcall %}

    Confirmation Modal:
        {{ Modal.confirmation(
            modal_id="delete-item",
            title="Delete Item",
            action=url_for('menu.delete', id=item.id),
            message="Are you sure you want to delete this item?",
            warning="This action cannot be undone.",
            confirm_text="Delete",
            confirm_icon="delete",
            confirm_color="red"
        ) }}

    Search Modal:
        {{ Modal.search(
            modal_id="search",
            action=url_for('menu.items'),
            placeholder="Search menu items..."
        ) }}

    Note: Modals use the Popover API. Trigger with popovertarget attribute.
#}


{# trigger(modal_id, label=None, icon=None, _class='')
   ----------------------------------------------------
   Creates a button that opens a modal using the popover API.

   Parameters:
       modal_id (str): Required. ID of the modal to trigger.
       label    (str): Optional. Button text (hidden on medium screens if icon present).
       icon     (str): Optional. Material Symbols icon name.
       _class   (str): Optional. Additional CSS classes for the button.
#}
{% macro trigger(modal_id, label=None, icon=None, _class='') %}
    <button class="btn{{ ' '+_class if _class is defined else '' }} waves-effect waves-light" popovertarget="{{ modal_id }}">
        {% if icon is defined and label is defined %}
            <i class="material-symbols-rounded">{{ icon }}</i>
            <span class="hide-on-med-and-down">&nbsp;{{ label }}</span>
        {% elif icon is defined %}
            <i class="material-symbols-rounded">{{ icon }}</i>
        {% else %}
            <span>{{ label if label is defined }}</span>
        {% endif %}
    </button>
{% endmacro %}


{# render(modal_id, title=None, _class='')
   ----------------------------------------
   Creates a basic modal dialog container.

   Parameters:
       modal_id (str): Required. Unique ID for the modal element.
       title    (str): Optional. Modal header title with close button.
       _class   (str): Optional. Additional CSS classes for the modal.

   Usage: Must be called with {% call %} to inject content via {{ caller() }}.
#}
{% macro render(modal_id, title=None, _class='') %}
    <div id="{{ modal_id }}" class="modal {{ _class if _class is defined }}" popover>
        {% if title %}
            <div class="modal-header flex flex-row items-center justify-between">
                <h5>{{ title }}</h5>
                <button class="btn-flat" popovertarget="{{ modal_id }}">
                    <i class="material-symbols-rounded">close</i>
                </button>
            </div>
        {% endif %}
        <div class="modal-content">
            {{ caller() }}
        </div>
        <div class="modal-footer">
            <button class="btn-flat waves-effect" popovertarget="{{ modal_id }}">Cancel</button>
        </div>
    </div>
{% endmacro %}


{# form_modal(modal_id, title, action='', method='post', _class='', submit_text=None, enctype=None)
   -------------------------------------------------------------------------------------------------
   Creates a modal with an embedded form, including Cancel and Submit buttons.

   Parameters:
       modal_id    (str): Required. Unique ID (without 'Modal' suffix - added automatically).
       title       (str): Required. Modal header title.
       action      (str): Optional. Form action URL. Defaults to current page.
       method      (str): Optional. Form method. Defaults to "post".
       _class      (str): Optional. Additional CSS classes for the modal.
       submit_text (str): Optional. Submit button text. Defaults to "Save".
       enctype     (str): Optional. Form enctype (e.g., "multipart/form-data" for file uploads).

   Usage: Must be called with {% call %} to inject form fields via {{ caller() }}.
#}
{% macro form_modal(modal_id, title, action='', method='post', _class='', submit_text=None, enctype=None) %}
    <div id="{{ modal_id }}Modal" class="modal {{ _class if _class is defined }}" popover>
        <form id="{{ modal_id }}Form" action="{{ action }}" method="{{ method }}"{% if enctype %}
              enctype="{{ enctype }}"{% endif %}>
            {% if title %}
                <div class="modal-header flex flex-row items-center justify-between">
                    <h5>{{ title }}</h5>
                    <button type="button" class="btn-flat" popovertarget="{{ modal_id }}Modal">
                        <i class="material-symbols-rounded">close</i>
                    </button>
                </div>
            {% endif %}
            <div class="modal-content">
                <div class="my-4">
                    {{ caller() }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn text waves-effect" popovertarget="{{ modal_id }}Modal">
                    <i class="material-symbols-rounded">cancel</i>
                    <span>&nbsp;Cancel</span>
                </button>
                <button type="submit" form="{{ modal_id }}Form" class="btn filled waves-effect waves-light">
                    <i class="material-symbols-rounded">save</i>
                    <span>&nbsp;{{ submit_text if submit_text else 'Save' }}</span>
                </button>
            </div>
        </form>
    </div>
{% endmacro %}


{# confirmation(modal_id, title, action, message, ...)
   ----------------------------------------------------
   Creates a confirmation dialog with optional password verification.

   Parameters:
       modal_id         (str):  Required. Unique ID (without 'Modal' suffix).
       title            (str):  Required. Modal header title.
       action           (str):  Required. Form action URL.
       message          (str):  Required. Main confirmation message (HTML allowed).
       warning          (str):  Optional. Warning text displayed below message.
       confirm_text     (str):  Optional. Confirm button text. Defaults to "Confirm".
       confirm_icon     (str):  Optional. Confirm button icon. Defaults to "check".
       confirm_color    (str):  Optional. Button color class (e.g., "red", "green").
       require_password (bool): Optional. Show password field. Defaults to False.
       method           (str):  Optional. Form method. Defaults to "post".
#}
{% macro confirmation(
    modal_id,
    title,
    action,
    message,
    warning=none,
    confirm_text='Confirm',
    confirm_icon='check',
    confirm_color='',
    require_password=false,
    method='post'
) %}
    <div id="{{ modal_id }}Modal" class="modal" popover>
        <form action="{{ action }}" method="{{ method }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="modal-header">
                <h5>{{ title }}</h5>
            </div>
            <div class="modal-content">
                <p>{{ message|safe }}</p>
                {% if warning %}
                    <p class="{% if confirm_color == 'red' %}red-text{% else %}grey-text{% endif %}">{{ warning }}</p>
                {% endif %}
                {% if require_password %}
                    <div class="input-field">
                        <input type="password" name="password" id="{{ modal_id }}-password" required>
                        <label for="{{ modal_id }}-password">Confirm your password</label>
                    </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn text waves-effect" popovertarget="{{ modal_id }}Modal">
                    <i class="material-symbols-rounded">cancel</i>
                    <span>&nbsp;Cancel</span>
                </button>
                <button type="submit" class="btn filled waves-effect waves-light {{ confirm_color }}">
                    <i class="material-symbols-rounded">{{ confirm_icon }}</i>
                    <span>&nbsp;{{ confirm_text }}</span>
                </button>
            </div>
        </form>
    </div>
{% endmacro %}


{# search(modal_id, action, placeholder='Search...', param='q', clear_url=None)
   -----------------------------------------------------------------------------
   Creates a search modal with input field and clear/search buttons.

   Parameters:
       modal_id    (str): Required. Unique ID (without 'Modal' suffix).
       action      (str): Required. Form action URL for search submission.
       placeholder (str): Optional. Input placeholder text. Defaults to "Search...".
       param       (str): Optional. Query parameter name. Defaults to "q".
       clear_url   (str): Optional. URL for clear button. Defaults to action URL.
#}
{% macro search(modal_id, action, placeholder='Search...', param='q', clear_url=none) %}
    <div id="{{ modal_id }}Modal" class="modal small" popover>
        <form action="{{ action }}" method="get">
            <div class="modal-header">
                <h5>Search</h5>
            </div>
            <div class="modal-content">
                <div class="input-field">
                    <i class="material-symbols-rounded prefix">search</i>
                    <input type="text" id="{{ modal_id }}-input" name="{{ param }}"
                           value="{{ request.args.get(param, '') }}"
                           placeholder="{{ placeholder }}"
                           autofocus>
                    <label for="{{ modal_id }}-input" class="sr-only">Search</label>
                </div>
            </div>
            <div class="modal-footer">
                <a href="{{ clear_url or action }}" class="btn text waves-effect">
                    <i class="material-symbols-rounded">clear</i>
                    <span>&nbsp;Clear</span>
                </a>
                <button type="submit" class="btn filled waves-effect waves-light">
                    <i class="material-symbols-rounded">search</i>
                    <span>&nbsp;Search</span>
                </button>
            </div>
        </form>
    </div>
{% endmacro %}