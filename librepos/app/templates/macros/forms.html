{#
    Forms Macro
    ===========
    Auto-renders WTForms with MaterializeCSS styling.

    Import:
        {% import "macros/forms.html" as Forms %}

    Basic Usage:
        <form method="post">
            {{ Forms.render(form) }}
        </form>

    With Custom Column Widths:
        <form method="post">
            {{ Forms.render(form, {'name': 'm6', 'email': 'm6'}) }}
        </form>

    Render Single Field:
        {{ Forms.render_field_auto(form.email) }}

    Supported Field Types:
        - StringField, PasswordField, EmailField, SearchField, TelField, URLField
        - IntegerField, DecimalField, FloatField (with optional stepper)
        - DateField, DateTimeLocalField
        - TextAreaField, SelectField, SelectMultipleField
        - BooleanField (checkbox or switch via render_kw={'render_as': 'switch'})
        - FileField (with drag-and-drop)
        - SubmitField
        - FieldList, FormField (nested forms)

    Switch Toggle:
        # In forms.py
        is_active = BooleanField('Active', render_kw={'render_as': 'switch'})

    Number Stepper:
        # In forms.py
        quantity = IntegerField('Qty', render_kw={'render_as': 'stepper'})
#}


{# ==========================================================================
   PRIVATE HELPER MACROS
   ========================================================================== #}

{# _wrapper_classes(field, extra_wrap)
   ------------------------------------
   Generates CSS classes for the field wrapper div.

   Parameters:
       field      (Field): WTForms field object.
       extra_wrap (str):   Optional. Additional CSS classes to append.

   Returns: String of CSS classes including 'input-field outlined col s12' plus any
            wrapper_class from field.render_kw or field.wrapper_class.
#}
{% macro _wrapper_classes(field, extra_wrap) %}
    {%- set classes = ['input-field outlined col s12'] -%}
    {%- set attr_wrap = field.wrapper_class if field.wrapper_class is defined else '' -%}
    {%- if not attr_wrap and field.render_kw and 'wrapper_class' in field.render_kw -%}
        {%- set attr_wrap = field.render_kw['wrapper_class'] -%}
    {%- endif -%}
    {{ (classes|join(' ') ~ ' ' ~ attr_wrap ~ ' ' ~ extra_wrap)|trim }}
{% endmacro %}


{# _input_classes(field, plus='')
   -------------------------------
   Generates CSS classes for the input element itself.

   Parameters:
       field (Field): WTForms field object.
       plus  (str):   Optional. Additional CSS classes to append.

   Returns: String of CSS classes from field.render_kw['class'] plus any extra classes.
#}
{% macro _input_classes(field, plus='') -%}
    {% set base = (field.render_kw.get('class') if field.render_kw and field.render_kw.get('class') else '') %}
    {{ (base ~ ' ' ~ plus).strip() }}
{%- endmacro %}


{# _errors(field)
   ---------------
   Renders validation error messages for a field.

   Parameters:
       field (Field): WTForms field object.

   Output: Red helper text span with comma-separated error messages, or nothing if no errors.
#}
{% macro _errors(field) -%}
    {% if field.errors %}
        <span class="helper-text red-text">{{ field.errors|join(', ') }}</span>
    {% endif %}
{%- endmacro %}


{# _help(field)
   -------------
   Renders the field's description as helper text.

   Parameters:
       field (Field): WTForms field object.

   Output: Helper text span with field.description, or nothing if no description.
#}
{% macro _help(field) -%}
    {% if field.description %}
        <span class="helper-text">{{ field.description }}</span>
    {% endif %}
{%- endmacro %}


{# ==========================================================================
   PRIVATE FIELD RENDERER MACROS
   ========================================================================== #}

{# _render_input(field, extra_wrap='')
   ------------------------------------
   Renders a standard text input field (text, email, password, date, etc.).

   Parameters:
       field      (Field): WTForms field object.
       extra_wrap (str):   Optional. Additional wrapper CSS classes.

   Output: MaterializeCSS outlined input-field with label, help text, and errors.
#}
{% macro _render_input(field, extra_wrap='') -%}
    <div class="{{ _wrapper_classes(field, extra_wrap) }}">
        {{ field(class=_input_classes(field), id=field.id, placeholder=" ") }}
        <label for="{{ field.id }}">{{ field.label.text }}</label>
        {{ _help(field) }}
        {{ _errors(field) }}
    </div>
{%- endmacro %}


{# _render_textarea(field, extra_wrap='')
   ---------------------------------------
   Renders a textarea field with MaterializeCSS auto-resize.

   Parameters:
       field      (Field): WTForms TextAreaField object.
       extra_wrap (str):   Optional. Additional wrapper CSS classes.

   Output: MaterializeCSS textarea with 'materialize-textarea' class for auto-resize.
#}
{% macro _render_textarea(field, extra_wrap='') -%}
    <div class="{{ _wrapper_classes(field, extra_wrap) }}">
        {{ field(class=_input_classes(field) + 'materialize-textarea', id=field.id) }}
        <label for="{{ field.id }}">{{ field.label.text }}</label>
        {{ _help(field) }}
        {{ _errors(field) }}
    </div>
{%- endmacro %}


{# _render_select(field, extra_wrap='')
   -------------------------------------
   Renders a select dropdown field.

   Parameters:
       field      (Field): WTForms SelectField or SelectMultipleField object.
       extra_wrap (str):   Optional. Additional wrapper CSS classes.

   Output: MaterializeCSS select element. Requires M.FormSelect.init() in JS.
#}
{% macro _render_select(field, extra_wrap='') -%}
    <div class="{{ _wrapper_classes(field, extra_wrap) }}">
        {{ field(class=_input_classes(field), id=field.id) }}
        <label for="{{ field.id }}">{{ field.label.text }}</label>
        {{ _help(field) }}
        {{ _errors(field) }}
    </div>
{%- endmacro %}


{# _render_check(field, extra_wrap='')
   ------------------------------------
   Renders a checkbox field.

   Parameters:
       field      (Field): WTForms BooleanField object.
       extra_wrap (str):   Optional. Additional wrapper CSS classes.

   Output: MaterializeCSS checkbox (not inside .input-field per Materialize requirements).
#}
{% macro _render_check(field, extra_wrap='') -%}
    {% set from_field = (field.render_kw.get('wrapper_class') if field.render_kw else '') %}
    {% set attr_wrap = field.wrapper_class if field.wrapper_class is defined else '' %}
    {% set wrapper = (from_field ~ ' ' ~ attr_wrap ~ ' ' ~ extra_wrap).strip() %}
    <div class="{{ wrapper }}">
        <label>
            {{ field(id=field.id) }}
            <span>{{ field.label.text }}</span>
        </label>
        {{ _help(field) }}
        {{ _errors(field) }}
    </div>
{%- endmacro %}


{# _render_switch(field, extra_wrap='')
   -------------------------------------
   Renders a toggle switch field (alternative to checkbox).

   Parameters:
       field      (Field): WTForms BooleanField with render_kw={'render_as': 'switch'}.
       extra_wrap (str):   Optional. Additional wrapper CSS classes.

   Output: MaterializeCSS switch with Off/On labels and lever.
#}
{% macro _render_switch(field, extra_wrap='') -%}
    {% set from_field = (field.render_kw.get('wrapper_class') if field.render_kw else '') %}
    {% set attr_wrap = field.wrapper_class if field.wrapper_class is defined else '' %}
    {% set wrapper = ('switch ' ~ from_field ~ ' ' ~ attr_wrap ~ ' ' ~ extra_wrap).strip() %}
    <div class="{{ wrapper }} col s12">
        <label>
            Off
            {{ field(id=field.id) }}
            <span class="lever"></span>
            On
        </label>
        {{ _help(field) }}
        {{ _errors(field) }}
    </div>
{%- endmacro %}


{# _render_file(field, extra_wrap='')
   -----------------------------------
   Renders a file input with drag-and-drop support.

   Parameters:
       field      (Field): WTForms FileField object.
       extra_wrap (str):   Optional. Additional wrapper CSS classes.

   Output: Custom dropzone UI with cloud upload icon, browse link, and preview area.
           Requires corresponding JS for drag-and-drop functionality.
#}
{% macro _render_file(field, extra_wrap='') -%}
    <div class="{{ _wrapper_classes(field, extra_wrap) }}">
        <label class="active">{{ field.label.text }}</label>
        <div class="file-dropzone" data-target="{{ field.id }}">
            <i class="material-symbols-rounded file-dropzone__icon">cloud_upload</i>
            <p class="file-dropzone__text">
                Drag & drop file here or <span class="primary-color-text">browse</span>
            </p>
            <p class="file-dropzone__preview"></p>
            {{ field(id=field.id, class="file-dropzone__input") }}
        </div>
        {{ _help(field) }}
        {{ _errors(field) }}
    </div>
{%- endmacro %}


{# _render_number_stepper(field, extra_wrap='')
   ---------------------------------------------
   Renders a number input with increment/decrement buttons.

   Parameters:
       field      (Field): WTForms IntegerField/DecimalField with render_kw={'render_as': 'stepper'}.
       extra_wrap (str):   Optional. Additional wrapper CSS classes.

   Output: Number input with +/- buttons. Requires JS to handle button clicks.
#}
{% macro _render_number_stepper(field, extra_wrap='') -%}
    <div class="{{ _wrapper_classes(field, extra_wrap) }} number-stepper">
        {{ field(class=_input_classes(field), id=field.id, placeholder=" ", min=0) }}
        <label for="{{ field.id }}">{{ field.label.text }}</label>
        <div class="number-stepper__controls">
            <button type="button"
                    class="number-stepper__btn"
                    data-action="decrement"
                    data-target="{{ field.id }}"
                    aria-label="Decrease value">
                <span aria-hidden="true">&minus;</span>
            </button>
            <button type="button"
                    class="number-stepper__btn"
                    data-action="increment"
                    data-target="{{ field.id }}"
                    aria-label="Increase value">
                <span aria-hidden="true">+</span>
            </button>
        </div>
        {{ _help(field) }}
        {{ _errors(field) }}
    </div>
{%- endmacro %}


{# _render_submit(field, extra_wrap='')
   -------------------------------------
   Renders a submit button with save icon.

   Parameters:
       field      (Field): WTForms SubmitField object.
       extra_wrap (str):   Optional. Additional wrapper CSS classes.

   Output: MaterializeCSS filled button with save icon and label text.
#}
{% macro _render_submit(field, extra_wrap='') -%}
    {% set classes = field.render_kw.get('class') if field.render_kw and field.render_kw.get('class') else 'btn' %}
    <div class="col s12 {{ (extra_wrap) }}">
        <button id="{{ field.id }}" class="btn filled waves-effect waves-light{{ ' '+classes if classes is defined }}"
                type="submit" name="{{ field.id }}">
            <i class="material-symbols-rounded">save</i>
            {% if field.label %}
                <span>&nbsp;{{ field.label.text if field.label.text else "Save" }}</span>
            {% endif %}
        </button>
    </div>
{%- endmacro %}


{# ==========================================================================
   PUBLIC MACROS
   ========================================================================== #}

{# render_field_auto(field, extra_wrap='')
   ----------------------------------------
   Auto-dispatches a WTForms field to the appropriate renderer based on field type.

   Parameters:
       field      (Field): Any WTForms field object.
       extra_wrap (str):   Optional. Additional wrapper CSS classes.

   Supported Types:
       - HiddenField, CSRFTokenField (rendered as-is)
       - IntegerField, DecimalField, FloatField (input or stepper)
       - StringField, PasswordField, EmailField, SearchField, TelField, URLField
       - DateField, DateTimeLocalField
       - TextAreaField, SelectField, SelectMultipleField
       - BooleanField (checkbox or switch)
       - FileField (drag-and-drop)
       - SubmitField
       - FieldList, FormField (recursive)

   Note: Use render_kw={'render_as': 'stepper'} for number stepper,
         render_kw={'render_as': 'switch'} for toggle switch.
#}
{% macro render_field_auto(field, extra_wrap='') -%}
    {% if field.type in ['HiddenField', 'CSRFTokenField'] %}
        {{ field }}
    {% elif field.type in ['IntegerField','DecimalField','FloatField'] %}
        {% if field.render_kw and field.render_kw.get('render_as') == 'stepper' %}
            {{ _render_number_stepper(field, extra_wrap) }}
        {% else %}
            {{ _render_input(field, extra_wrap) }}
        {% endif %}
    {% elif field.type in [
        'StringField','PasswordField','EmailField','SearchField',
        'TelField','URLField','DateField','DateTimeLocalField'
      ] %}
        {{ _render_input(field, extra_wrap) }}
    {% elif field.type == 'TextAreaField' %}
        {{ _render_textarea(field, extra_wrap) }}
    {% elif field.type in ['SelectField','SelectMultipleField'] %}
        {{ _render_select(field, extra_wrap) }}
    {% elif field.type == 'BooleanField' %}
        {% if field.render_kw and field.render_kw.get('render_as') == 'switch' %}
            {{ _render_switch(field, extra_wrap) }}
        {% else %}
            {{ _render_check(field, extra_wrap) }}
        {% endif %}
    {% elif field.type == 'FileField' %}
        {{ _render_file(field, extra_wrap) }}
    {% elif field.type == 'SubmitField' %}
        {{ _render_submit(field, extra_wrap) }}
    {% elif field.type == 'FieldList' %}
        {# Render each entry; if it contains subform, recurse #}
        <div class="{{ _wrapper_classes(field, extra_wrap) }}">
            <label class="active">{{ field.label.text }}</label>
            {% for sub in field %}
                {% if sub.type == 'FormField' and sub.form %}
                    {{ render_subform(sub.form, extra_wrap) }}
                {% else %}
                    {{ render_field_auto(sub, extra_wrap) }}
                {% endif %}
            {% endfor %}
            {{ _help(field) }}
            {{ _errors(field) }}
        </div>
    {% elif field.type == 'FormField' %}
        {{ render_subform(field.form, extra_wrap) }}
    {% else %}
        {# Fallback to input renderer #}
        {{ _render_input(field, extra_wrap) }}
    {% endif %}
{%- endmacro %}


{# render_subform(form, extra_wrap='')
   ------------------------------------
   Renders all fields of a nested form (FormField).

   Parameters:
       form       (Form): WTForms form object (from FormField.form).
       extra_wrap (str):  Optional. Additional wrapper CSS classes for all fields.

   Note: Automatically skips CSRFTokenField to avoid duplicate tokens.
#}
{% macro render_subform(form, extra_wrap='') -%}
    {% for f in form if f.type != 'CSRFTokenField' %}
        {{ render_field_auto(f, extra_wrap) }}
    {% endfor %}
{%- endmacro %}


{# render(form, extra_wrappers={})
   --------------------------------
   Renders an entire WTForms form with MaterializeCSS styling.

   Parameters:
       form           (Form): WTForms form object.
       extra_wrappers (dict): Optional. Field-specific wrapper classes.
                              Example: {'name': 'm6', 'email': 'm6'} for half-width fields.

   Output: Hidden fields first (including CSRF), then all visible fields in a row div.
           Each field is rendered via render_field_auto() with appropriate styling.

   Example:
       <form method="post">
           {{ Forms.render(form) }}
       </form>

       <form method="post">
           {{ Forms.render(form, {'name': 'm6', 'email': 'm6'}) }}
       </form>
#}
{% macro render(form, extra_wrappers={}) -%}
    {% for f in form if f.type in ['HiddenField', 'CSRFTokenField'] %}
        {{ f }}
    {% endfor %}

    <div class="row">
        {% for field in form if field.type not in ['HiddenField','CSRFTokenField'] %}
            {# allow per-call override: extra_wrappers = {'name': 'col s12 m6'} #}
            {% set extra = extra_wrappers.get(field.name, '') %}
            {{ render_field_auto(field, extra) }}
        {% endfor %}
    </div>
{%- endmacro %}
