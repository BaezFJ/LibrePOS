{# ---------- Low-level helpers ---------- #}
{% macro _wrapper_classes(field, extra_wrap) %}
    {%- set classes = ['input-field outlined col s12'] -%}
    {%- set attr_wrap = field.wrapper_class if field.wrapper_class is defined else '' -%}
    {%- if not attr_wrap and field.render_kw and 'wrapper_class' in field.render_kw -%}
        {%- set attr_wrap = field.render_kw['wrapper_class'] -%}
    {%- endif -%}
    {{ (classes|join(' ') ~ ' ' ~ attr_wrap ~ ' ' ~ extra_wrap)|trim }}
{% endmacro %}

{% macro _input_classes(field, plus='') -%}
    {% set base = (field.render_kw.get('class') if field.render_kw and field.render_kw.get('class') else '') %}
    {{ (base ~ ' ' ~ plus).strip() }}
{%- endmacro %}

{% macro _errors(field) -%}
    {% if field.errors %}
        <span class="helper-text red-text">{{ field.errors|join(', ') }}</span>
    {% endif %}
{%- endmacro %}

{% macro _help(field) -%}
    {% if field.description %}
        <span class="helper-text">{{ field.description }}</span>
    {% endif %}
{%- endmacro %}

{# ---------- Field renderers ---------- #}
{% macro _render_input(field, extra_wrap='') -%}
    <div class="{{ _wrapper_classes(field, extra_wrap) }}">
        {{ field(class=_input_classes(field), id=field.id, placeholder=" ") }}
        <label for="{{ field.id }}">{{ field.label.text }}</label>
        {{ _help(field) }}
        {{ _errors(field) }}
    </div>
{%- endmacro %}

{% macro _render_textarea(field, extra_wrap='') -%}
    <div class="{{ _wrapper_classes(field, extra_wrap) }}">
        {{ field(class=_input_classes(field) + 'materialize-textarea', id=field.id) }}
        <label for="{{ field.id }}">{{ field.label.text }}</label>
        {{ _help(field) }}
        {{ _errors(field) }}
    </div>
{%- endmacro %}

{% macro _render_select(field, extra_wrap='') -%}
    <div class="{{ _wrapper_classes(field, extra_wrap) }}">
        {{ field(class=_input_classes(field), id=field.id) }}
        <label for="{{ field.id }}">{{ field.label.text }}</label>
        {{ _help(field) }}
        {{ _errors(field) }}
    </div>
{%- endmacro %}

{% macro _render_check(field, extra_wrap='') -%}
    {# Materialize checkboxes are not inside .input-field #}
    {% set from_field = (field.render_kw.get('wrapper_class') if field.render_kw else '') %}
    {% set attr_wrap = field.wrapper_class if field.wrapper_class is defined else '' %}
    {% set wrapper = (from_field ~ ' ' ~ attr_wrap ~ ' ' ~ extra_wrap).strip() %}
    <div class="{{ wrapper }}">
        <label>
            {{ field(id=field.id) }}
            <span>{{ field.label.text }}</span>
        </label>
        {{ _help(field) }}
        {{ _errors(field) }}
    </div>
{%- endmacro %}

{% macro _render_switch(field, extra_wrap='') -%}
    {# Materialize switches are not inside .input-field #}
    {% set from_field = (field.render_kw.get('wrapper_class') if field.render_kw else '') %}
    {% set attr_wrap = field.wrapper_class if field.wrapper_class is defined else '' %}
    {% set wrapper = ('switch ' ~ from_field ~ ' ' ~ attr_wrap ~ ' ' ~ extra_wrap).strip() %}
    <div class="{{ wrapper }} col s12">
        <label>
            Off
            {{ field(id=field.id) }}
            <span class="lever"></span>
            On
        </label>
        {{ _help(field) }}
        {{ _errors(field) }}
    </div>
{%- endmacro %}

{% macro _render_file(field, extra_wrap='') -%}
    {# Enhanced file input with drag-and-drop support #}
    <div class="{{ _wrapper_classes(field, extra_wrap) }}">
        <label class="active">{{ field.label.text }}</label>
        <div class="file-dropzone" data-target="{{ field.id }}">
            <i class="material-symbols-rounded file-dropzone__icon">cloud_upload</i>
            <p class="file-dropzone__text">
                Drag & drop file here or <span class="primary-color-text">browse</span>
            </p>
            <p class="file-dropzone__preview"></p>
            {{ field(id=field.id, class="file-dropzone__input") }}
        </div>
        {{ _help(field) }}
        {{ _errors(field) }}
    </div>
{%- endmacro %}

{% macro _render_number_stepper(field, extra_wrap='') -%}
    {# Number input with increment/decrement buttons #}
    <div class="{{ _wrapper_classes(field, extra_wrap) }} number-stepper">
        {{ field(class=_input_classes(field), id=field.id, placeholder=" ", min=0) }}
        <label for="{{ field.id }}">{{ field.label.text }}</label>
        <div class="number-stepper__controls">
            <button type="button"
                    class="number-stepper__btn"
                    data-action="decrement"
                    data-target="{{ field.id }}"
                    aria-label="Decrease value">
                <span aria-hidden="true">&minus;</span>
            </button>
            <button type="button"
                    class="number-stepper__btn"
                    data-action="increment"
                    data-target="{{ field.id }}"
                    aria-label="Increase value">
                <span aria-hidden="true">+</span>
            </button>
        </div>
        {{ _help(field) }}
        {{ _errors(field) }}
    </div>
{%- endmacro %}

{% macro _render_submit(field, extra_wrap='') -%}
    {% set classes = field.render_kw.get('class') if field.render_kw and field.render_kw.get('class') else 'btn' %}
    <div class="col s12 {{ (extra_wrap) }}">
        <button id="{{ field.id }}" class="btn filled waves-effect waves-light{{ ' '+classes if classes is defined }}"
                type="submit" name="{{ field.id }}">
            <i class="material-symbols-rounded">save</i>
            {% if field.label %}
                <span>&nbsp;{{ field.label.text if field.label.text else "Save" }}</span>
            {% endif %}
        </button>
    </div>
{%- endmacro %}

{# ---------- Dispatcher for a single field ---------- #}
{% macro render_field_auto(field, extra_wrap='') -%}
    {# Hidden and CSRF handled at form-level; skip here if hidden #}
    {% if field.type in ['HiddenField', 'CSRFTokenField'] %}
        {{ field }}
    {% elif field.type in ['IntegerField','DecimalField','FloatField'] %}
        {% if field.render_kw and field.render_kw.get('render_as') == 'stepper' %}
            {{ _render_number_stepper(field, extra_wrap) }}
        {% else %}
            {{ _render_input(field, extra_wrap) }}
        {% endif %}
    {% elif field.type in [
        'StringField','PasswordField','EmailField','SearchField',
        'TelField','URLField','DateField','DateTimeLocalField'
      ] %}
        {{ _render_input(field, extra_wrap) }}
    {% elif field.type == 'TextAreaField' %}
        {{ _render_textarea(field, extra_wrap) }}
    {% elif field.type in ['SelectField','SelectMultipleField'] %}
        {{ _render_select(field, extra_wrap) }}
    {% elif field.type == 'BooleanField' %}
        {% if field.render_kw and field.render_kw.get('render_as') == 'switch' %}
            {{ _render_switch(field, extra_wrap) }}
        {% else %}
            {{ _render_check(field, extra_wrap) }}
        {% endif %}
    {% elif field.type == 'FileField' %}
        {{ _render_file(field, extra_wrap) }}
    {% elif field.type == 'SubmitField' %}
        {{ _render_submit(field, extra_wrap) }}
    {% elif field.type == 'FieldList' %}
        {# Render each entry; if it contains subform, recurse #}
        <div class="{{ _wrapper_classes(field, extra_wrap) }}">
            <label class="active">{{ field.label.text }}</label>
            {% for sub in field %}
                {% if sub.type == 'FormField' and sub.form %}
                    {{ render_subform(sub.form, extra_wrap) }}
                {% else %}
                    {{ render_field_auto(sub, extra_wrap) }}
                {% endif %}
            {% endfor %}
            {{ _help(field) }}
            {{ _errors(field) }}
        </div>
    {% elif field.type == 'FormField' %}
        {{ render_subform(field.form, extra_wrap) }}
    {% else %}
        {# Fallback to input renderer #}
        {{ _render_input(field, extra_wrap) }}
    {% endif %}
{%- endmacro %}

{# ---------- Subform (FormField) ---------- #}
{% macro render_subform(form, extra_wrap='') -%}
    {% for f in form if f.type != 'CSRFTokenField' %}
        {{ render_field_auto(f, extra_wrap) }}
    {% endfor %}
{%- endmacro %}

{# ---------- MAIN: render a whole form ---------- #}
{% macro render(form, extra_wrappers={}) -%}
    {# collect hidden fields (including csrf) #}
    {% for f in form if f.type in ['HiddenField', 'CSRFTokenField'] %}
        {{ f }}
    {% endfor %}

    <div class="row">
        {% for field in form if field.type not in ['HiddenField','CSRFTokenField'] %}
            {# allow per-call override: extra_wrappers = {'name': 'col s12 m6'} #}
            {% set extra = extra_wrappers.get(field.name, '') %}
            {{ render_field_auto(field, extra) }}
        {% endfor %}
    </div>
{%- endmacro %}
